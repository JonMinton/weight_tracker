---
title: "Weight Tracker"
output: html_notebook
---

# Introduction

This will track and try to make sense of changes in weight over time. The data will have to be manually recorded on an Excel workbook.


# Packages etc

```{r}
pacman::p_load(
  openxlsx, tidyverse, plotly
)

```
Data 


```{r}
data <- readxl::read_excel("weight_over_time.xlsx", sheet = "raw_data", col_types = c("date", "skip", "numeric", "skip"))

```

# Find AM and PM

```{r}
delta_data <- 
  data %>% 
    mutate(
      tod = ifelse(lubridate::am(date), "AM", "PM")
    ) %>% 
    mutate(
      day_alone = lubridate::as_date(date)
    ) %>% 
    select(day_alone, tod, weight) %>% 
    group_by(day_alone, tod) %>% 
    summarise( min_max_weight = case_when(
      tod[1] == "AM" ~ min(weight),
      tod[1] == "PM" ~ max(weight)
      )
    )

```

Now to visualise 


```{r, fig.height=6, fig.width = 8}

# regression model
mod <- lm(min_max_weight ~ day_alone + tod, data = delta_data)

# get equation
# https://stackoverflow.com/questions/7549694/add-regression-line-equation-and-r2-on-graph

lm_eqn <- function(m){
  m_tidy <- broom::tidy(mod)
  m_glance <- broom::glance(mod)
  trend_point <- m_tidy %>% pluck(2, 2) %>% round(2)
  trend_se    <- m_tidy %>% pluck(3, 2) %>% `*`(2) %>% round(2)
  daily_point <- m_tidy %>% pluck(2, 3) %>% round(2) 
  daily_se    <- m_tidy %>% pluck(3, 3) %>% `*`(2) %>% round(2)
  adj_r_sq    <- m_glance$adj.r.squared[1]  %>% round(2)
  glue::glue("Daily fall of {trend_point} (\u00b1 {trend_se}) kg/ day\n
             Daily variation of {daily_point} (\u00b1 {daily_se}) kg\n
             Ratio: {round(abs(daily_point / trend_point), 2)}\n
             Adjusted R-squared: {adj_r_sq}
             ")
}

delta_data %>% 
  modelr::add_predictions(., mod) %>% 
  ggplot(aes(x = day_alone)) + 
  geom_point(aes(y = min_max_weight, shape = tod, group = tod, colour = tod)) + 
  geom_line(aes(y = pred, group = tod, colour = tod)) +
  scale_y_continuous(breaks = 70:80) + 
  scale_x_date(breaks = "1 week", 
               minor_breaks = "1 day",
               labels = scales::date_format("%d %b") 
               ) + 
  expand_limits(y = c(72, 78)) + 
  labs(
    x = "Date",
    y = "Weight in kg",
    title = "Minimum morning and maximum evening weight over time",
    subtitle = "Blue line: BMI of 25. Dashed line: 95% of initial weight",
    shape = "Time of day", colour = "Time of day"
  ) + 
  geom_hline(yintercept = 72.7, linetype = "dashed", size = 1.5) + 
  geom_hline(yintercept = 74.2, linetype = "solid", colour = "darkblue") +
  geom_text(x = as.Date("2020-08-24"), y = 77.5, label = lm_eqn(mod), colour = "black", hjust = 0) + 
  expand_limits(y = c(70, 80))

ggsave("weight_chart.png", height = 20, width = 30, units = "cm", dpi = 300)
  
```



And linear regression

```{r}
mod <- lm(min_max_weight ~ day_alone + tod, data = delta_data)

```

```{r}
summary(mod)

```


So, on the basis of this there's a statistically significant downward trend of about 0.09 kg / day, but this is dwarfed by daily variation which is around 1.3 kg / day, i.e. 10x its magnitude


```{r}
mod2 <- lm(min_max_weight ~ day_alone, data = delta_data)

summary(mod2)

anova(mod, mod2)

```


# Weekly summaries 


```{r}
mdls_by_week <- 
  delta_data %>% 
    mutate(
      week = lubridate::week(day_alone)
    ) %>% 
    group_by(week) %>% 
    nest() %>% 
    mutate(mdl = map(.x = data, ~lm(min_max_weight ~ day_alone + tod, data = .))) %>% 
    mutate(mdl_tidy = map(mdl, broom::tidy)) %>% 
    mutate(mdl_sum = map(mdl, broom::glance))


mdls_by_week %>% 
  select(week, mdl_tidy) %>% 
  unnest(mdl_tidy) %>% 
  filter(term != "(Intercept)") %>% 
  mutate(
    estimate = ifelse(term == "day_alone", estimate * 7, estimate),
    std_error = ifelse(term == "day_alone", std.error * 7, std.error)
  ) %>% 
  mutate(lower = estimate - 2 * std.error,
         upper = estimate + 2 * std.error) %>% 
  select(week, term, estimate, lower, upper) %>% 
  left_join(
    mdls_by_week %>% 
      select(week, mdl_sum) %>% 
      unnest(mdl_sum) %>% 
      ungroup() %>%  
      select(week, adj.r.squared)
  ) %>% 
  filter(week > 31) %>% 
  mutate(term = case_when(
    term == "day_alone" ~ "Change in week",
    term == "todPM"       ~ "Within-day variation",
    TRUE                    ~ NA_character_
  )) %>% 
  ggplot(aes(x = week)) + 
  geom_point(aes(y = estimate, size = adj.r.squared)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) + 
  facet_wrap(~term)  +
  geom_hline(yintercept = 0) + 
  labs(
    x = "Week of year",
    y = "Estimate in kg",
    title = "Coefficients on trend and within-day variation by week",
    subtitle = "Error bars: Two standard errors. Point size proportional to model fit"
  ) + theme(legend.position  = "none")

ggsave("coeffs_by_week.png", height = 20, width = 30, units = "cm", dpi = 300)








```